<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>黃金買賣計算器 - 容錯新版</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 480px; margin: auto; padding: 20px; }
  h1 { text-align: center; margin-bottom: 20px; }
  button { cursor: pointer; }
  button.main-btn {
    width: 80%; margin: 15px auto; padding: 15px; border-radius: 8px; border:none; background:#007bff; color:#fff; font-size: 1.25em;
  }
  button.main-btn:hover { background:#0056b3; }
  .selector { text-align: center; margin-bottom: 10px; }
  section { display: none; border: 1px solid #ccc; border-radius: 8px; padding: 15px; margin-bottom: 25px; }
  section.active { display: block; }
  label { display: block; margin: 10px 0 5px 0; font-weight: 600; }
  input[type=number], input[type=text] {
    width: 100%; padding: 8px; font-size: 1.1em; border-radius: 5px; border: 1px solid #aaa; box-sizing: border-box;
  }
  .inline-flex { display: flex; align-items: center; gap: 10px; }
  .inline-flex input[type=radio], .inline-flex input[type=checkbox] { width: auto; }
  .purity-options label { cursor: pointer; user-select: none; }
  .result { margin-top: 15px; font-size: 1.15em; font-weight: bold; color: #007bff; }
  .profit-positive { color: green; }
  .profit-negative { color: red; }
  .note {
    font-size: 0.9em;
    color: #555;
    margin-top: 8px;
    font-style: italic;
  }
</style>
</head>
<body>

<h1>黃金買賣計算器</h1>

<div class="selector">
  <button id="btnBuy" class="main-btn">買入計算器</button>
  <button id="btnSell" class="main-btn">賣出計算器</button>
</div>

<section id="buySection">
  <label>實時黃金價格 (HKD / 台兩):</label>
  <input id="buyGoldPrice" type="number" placeholder="載入中，無法獲取金價時可手動輸入" />
  <button id="refreshBuyPrice" style="margin:10px auto;display:block;">刷新金價</button>

  <label>景輝收金價 (HKD / 台兩):</label>
  <input id="chingfaiBuyPrice" type="number" min="0" step="0.01" placeholder="輸入本地收金價" />

  <label>重量 (1/1000 香港台兩):</label>
  <input id="buyWeight" type="number" min="0" step="any" placeholder="輸入重量" />

  <label>純度選擇:</label>
  <div class="inline-flex purity-options">
    <label><input type="radio" name="buyPurity" value="100" checked />100%</label>
    <label><input type="radio" name="buyPurity" value="75" />75%</label>
    <label><input type="radio" name="buyPurity" value="custom" />自訂</label>
  </div>
  <input id="buyPurityCustom" type="number" min="0" max="100" step="0.01" placeholder="自訂純度 (%)" style="display:none;" />

  <label>客戶要求收貨價 (HKD):</label>
  <input id="requestedBuyPrice" type="number" min="0" step="any" placeholder="可留空以使用計算結果" />

  <div class="result" id="buyResult"></div>
  <button id="resetBuy" type="button" class="main-btn">重置買入計算</button>
</section>

<section id="sellSection">
  <label>實時黃金價格 (HKD / 台兩):</label>
  <input id="sellGoldPrice" type="number" placeholder="載入中，無法獲取金價時可手動輸入" />
  <button id="refreshSellPrice" style="margin:10px auto;display:block;">刷新金價</button>

  <label>景輝賣金價 (HKD / 台兩):</label>
  <input id="chingfaiSellPrice" type="number" min="0" step="0.01" placeholder="輸入本地賣金價" />

  <label>重量 (1/1000 香港台兩):</label>
  <input id="sellWeight" type="number" min="0" step="any" placeholder="輸入重量" />

  <label>純度選擇:</label>
  <div class="inline-flex purity-options">
    <label><input type="radio" name="sellPurity" value="100" checked />100%</label>
    <label><input type="radio" name="sellPurity" value="75" />75%</label>
    <label><input type="radio" name="sellPurity" value="custom" />自訂</label>
  </div>
  <input id="sellPurityCustom" type="number" min="0" max="100" step="0.01" placeholder="自訂純度 (%)" style="display:none;" />

  <label>人工費 (HKD):</label>
  <input id="labourCost" type="number" min="0" step="any" placeholder="輸入人工費用" />

  <label class="inline-flex"><input id="commissionSell" type="checkbox" checked /> 加入2%佣金</label>

  <label>售價 (HKD):</label>
  <input id="userSellingPrice" type="number" min="0" step="any" placeholder="可修改以模擬利潤" />

  <label>計算賣出價:</label>
  <div id="calculatedSellPrice" class="display-field">尚未計算</div>

  <label class="inline-flex"><input id="creditCardFee" type="checkbox" /> 承擔信用卡費用(3%)
    <span id="creditCardFeeAmount" style="margin-left: 10px; font-weight: normal; font-size: 0.9em; color: #555;"></span>
  </label>

  <div class="result" id="sellResult"></div>
  <button id="resetSell" type="button" class="main-btn">重置賣出計算</button>
</section>

<script>
(() => {
  // Cache all needed DOM elements
  const buyBtn = document.getElementById('btnBuy');
  const sellBtn = document.getElementById('btnSell');
  const buySection = document.getElementById('buySection');
  const sellSection = document.getElementById('sellSection');

  const buyGoldPrice = document.getElementById('buyGoldPrice');
  const chingfaiBuyPrice = document.getElementById('chingfaiBuyPrice');
  const buyWeight = document.getElementById('buyWeight');
  const buyPurityRadios = document.getElementsByName('buyPurity');
  const buyPurityCustom = document.getElementById('buyPurityCustom');
  const requestedBuyPrice = document.getElementById('requestedBuyPrice');
  const buyResult = document.getElementById('buyResult');
  const resetBuy = document.getElementById('resetBuy');
  const refreshBuyPrice = document.getElementById('refreshBuyPrice');

  const sellGoldPrice = document.getElementById('sellGoldPrice');
  const chingfaiSellPrice = document.getElementById('chingfaiSellPrice');
  const sellWeight = document.getElementById('sellWeight');
  const sellPurityRadios = document.getElementsByName('sellPurity');
  const sellPurityCustom = document.getElementById('sellPurityCustom');
  const labourCost = document.getElementById('labourCost');
  const commissionSell = document.getElementById('commissionSell');
  const userSellingPrice = document.getElementById('userSellingPrice');
  const calculatedSellPrice = document.getElementById('calculatedSellPrice');
  const creditCardFee = document.getElementById('creditCardFee');
  const creditCardFeeAmount = document.getElementById('creditCardFeeAmount');
  const sellResult = document.getElementById('sellResult');
  const resetSell = document.getElementById('resetSell');
  const refreshSellPrice = document.getElementById('refreshSellPrice');

  const gramsPerHKTael = 37.429;
  const gramsPerTroyOz = 31.1035;

  const API_KEY = 'b59eca630c98a8dbc001ff5d576db229';
  const API_URL = `https://api.metalpriceapi.com/v1/latest?api_key=${API_KEY}&base=USD&currencies=XAU,HKD`;

  function showSection(section) {
    if(section === 'buy') {
      buySection.style.display = 'block';
      sellSection.style.display = 'none';
    } else {
      buySection.style.display = 'none';
      sellSection.style.display = 'block';
    }
  }

  buyBtn.onclick = () => showSection('buy');
  sellBtn.onclick = () => showSection('sell');

  // Utilities to get purity value for both calculators
  function getSelectedPurity(radioNodeList, customInput) {
    for(const radio of radioNodeList){
      if(radio.checked){
        if(radio.value === 'custom'){
          const val = parseFloat(customInput.value);
          return isNaN(val) ? 0 : val;
        }
        return parseFloat(radio.value);
      }
    }
    return 0;
  }

  function calculatePureWeight(weightInput, purity) {
    const weightThousand = parseFloat(weightInput.value);
    if(isNaN(weightThousand) || purity <= 0) return 0;
    const weightTael = weightThousand / 1000;
    return weightTael * (purity / 100);
  }

  // Buy calculator function
  function calculateBuy() {
    if(!buyGoldPrice.value || chingfaiBuyPrice.value === '') {
      buyResult.textContent = '請輸入所有必要數據';
      return;
    }
    const purity = getSelectedPurity(buyPurityRadios, buyPurityCustom);
    const pureWeight = calculatePureWeight(buyWeight, purity);
    const chingfaiPrice = parseFloat(chingfaiBuyPrice.value) || 0;
    const commissionMultiplier = 0.98;// 2% commission deducted
    const estimatedBuyPrice = chingfaiPrice * pureWeight * commissionMultiplier;
    let requestedPrice = parseFloat(requestedBuyPrice.value);
    if (isNaN(requestedPrice)) requestedPrice = estimatedBuyPrice;

    const profit = estimatedBuyPrice - requestedPrice;

    buyResult.innerHTML = `
      純金重量: ${pureWeight.toFixed(4)} 香港台兩<br/>
      實估買入價（扣佣後）: 港幣 ${estimatedBuyPrice.toFixed(2)}<br/>
      客戶要求收貨價: 港幣 ${requestedPrice.toFixed(2)}<br/>
      利潤: <span style="color:${profit >=0 ? 'green':'red'}">港幣 ${profit.toFixed(2)} ${profit >=0 ? '✅' : '❌'}</span>
    `;
  }

  // Sell calculator function
  function calculateSell(){
    if(!sellGoldPrice.value || chingfaiSellPrice.value === ''){
      sellResult.textContent = '請輸入所有必要數據';
      return;
    }
    const purity = getSelectedPurity(sellPurityRadios, sellPurityCustom);
    const pureWeight = calculatePureWeight(sellWeight, purity);
    const chingfaiPrice = parseFloat(chingfaiSellPrice.value) || 0;
    let basePrice = chingfaiPrice * pureWeight;
    if(commissionSell.checked) basePrice *= 1.02;
    const userPrice = parseFloat(userSellingPrice.value);
    const sellPrice = !isNaN(userPrice) && userPrice > 0 ? userPrice : basePrice;
    const labour = parseFloat(labourCost.value) || 0;
    let profit = sellPrice - (pureWeight * parseFloat(sellGoldPrice.value)) - labour;
    let creditFee = 0;
    if(creditCardFee.checked){
      creditFee = sellPrice * 0.03;
      profit -= creditFee;
    }

    calculatedSellPrice.textContent = basePrice > 0 ? `計算出的賣出價：HKD ${basePrice.toFixed(2)}` : '尚未計算';

    creditCardFeeAmount.textContent = creditFee > 0 ? `(HKD ${creditFee.toFixed(2)})` : '';

    sellResult.innerHTML = `
      純金重量: ${pureWeight.toFixed(4)} 香港台兩<br/>
      理論黃金價值: 港幣 ${(pureWeight * parseFloat(sellGoldPrice.value)).toFixed(2)}<br/>
      人工費用: 港幣 ${labour.toFixed(2)}<br/>
      ${creditCardFee.checked ? '承擔信用卡費用 (3%)<br/>' : ''}
      利潤: <span style="color:${profit >= 0 ? 'green':'red'}">港幣 ${profit.toFixed(2)} ${profit >=0 ? '✅' : '❌'}</span>
    `;
  }

  // Reset functions
  function resetBuy(){
    chingfaiBuyPrice.value = '';
    buyWeight.value = '';
    buyPurityCustom.value = '';
    requestedBuyPrice.value = '';
    buyPurityRadios[0].checked = true;
    buyResult.textContent = '';
    calculateBuy();
  }

  function resetSell(){
    chingfaiSellPrice.value = '';
    sellWeight.value = '';
    labourCost.value  = '';
    sellPurityCustom.value = '';
    userSellingPrice.value = '';
    commissionSell.checked = true;
    creditCardFee.checked = false;
    sellPurityRadios[0].checked = true;
    sellResult.textContent = '';
    calculatedSellPrice.textContent = '尚未計算';
    creditCardFeeAmount.textContent = '';
    calculateSell();
  }

  // Toggle display of custom purity input
  function setupPurityRadios(radioNodeList, customInput){
    radioNodeList.forEach(radio => {
      radio.addEventListener('change', () => {
        if(radio.value === 'custom'){
          customInput.style.display = 'block';
        } else {
          customInput.style.display = 'none';
          customInput.value = '';
        }
        if(radioNodeList === buyPurityRadios){
          calculateBuy();
        } else {
          calculateSell();
        }
      });
    });

    customInput.addEventListener('input', () => {
      if(customInput.value === '') return;
      if(radioNodeList === buyPurityRadios){
        calculateBuy();
      } else {
        calculateSell();
      }
    });
  }

  // Add listeners for inputs
  function setupListeners(){
    [chingfaiBuyPrice, buyWeight, requestedBuyPrice].forEach(input => input.addEventListener('input', calculateBuy));
    [chingfaiSellPrice, sellWeight, labourCost, userSellingPrice].forEach(input => input.addEventListener('input', calculateSell));
    commissionSell.addEventListener('change', calculateSell);
    creditCardFee.addEventListener('change', calculateSell);

    refreshBuyPrice.addEventListener('click', fetchGoldPrice);
    refreshSellPrice.addEventListener('click', fetchGoldPrice);

    resetBuy.addEventListener('click', resetBuy);
    resetSell.addEventListener('click', resetSell);

    buyPurityRadios.forEach(radio => radio.addEventListener('change', calculateBuy));
    sellPurityRadios.forEach(radio => radio.addEventListener('change', calculateSell));

    setupPurityRadios(buyPurityRadios, buyPurityCustom);
    setupPurityRadios(sellPurityRadios, sellPurityCustom);
  }

  function fetchGoldPrice(){
    fetch(API_URL)
      .then(res => res.json())
      .then(data => {
        if(data.success && data.rates && 'XAU' in data.rates && 'HKD' in data.rates){
          const goldUSD = data.rates.XAU;
          const usdToHkd = data.rates.HKD;
          // convert to HKD per tael
          const goldHKD = goldUSD * usdToHkd;
          const goldTael = goldHKD * (gramsPerHKTael / gramsPerTroyOz);
          buyGoldPrice.value = goldTael.toFixed(2);
          sellGoldPrice.value = goldTael.toFixed(2);
          buyGoldPrice.readOnly = true;
          sellGoldPrice.readOnly = true;
          calculateBuy();
          calculateSell();
        } else {
          buyGoldPrice.value = '';
          sellGoldPrice.value = '';
          buyGoldPrice.readOnly = false;
          sellGoldPrice.readOnly = false;
          alert('未能自動獲取金價，請手動輸入');
        }
      })
      .catch(err => {
        buyGoldPrice.value = '';
        buyGoldPrice.readOnly = false;
        sellGoldPrice.value = '';
        sellGoldPrice.readOnly = false;
        alert('獲取金價時發生錯誤，請手動輸入');
      });
  }

  // Initialize page
  showSection('buy');
  setupListeners();
  fetchGoldPrice();
})();
</script>

</body>
</html>

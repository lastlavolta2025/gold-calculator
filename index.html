<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>黃金買賣計算器 - 全新版本</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 480px; margin: auto; padding: 20px; }
  h1 { text-align: center; margin-bottom: 20px; }
  button { cursor: pointer; }
  button.main-btn {
    width: 80%; margin: 15px auto; padding: 15px; border-radius: 8px; border:none; background:#007bff; color:#fff; font-size: 1.25em;
  }
  button.main-btn:hover { background:#0056b3; }

  .selector { text-align: center; margin-bottom: 10px; }
  section { display: none; border: 1px solid #ccc; border-radius: 8px; padding: 15px; margin-bottom: 25px; }
  section.active { display: block; }
  label { display: block; margin: 10px 0 5px 0; font-weight: 600; }
  input[type=number], input[type=text] {
    width: 100%; padding: 8px; font-size: 1.1em; border-radius: 5px; border: 1px solid #aaa; box-sizing: border-box;
  }
  .inline-flex { display: flex; align-items: center; gap: 10px; }
  .inline-flex input[type=radio], .inline-flex input[type=checkbox] { width: auto; }
  .purity-options label { cursor: pointer; user-select: none; }
  .result { margin-top: 15px; font-size: 1.15em; font-weight: bold; color: #007bff; }
  .profit-positive { color: green; }
  .profit-negative { color: red; }

  .note {
    font-size: 0.9em;
    color: #555;
    margin-top: 8px;
    font-style: italic;
  }
</style>
</head>
<body>

<h1>黃金買賣計算器</h1>

<div class="selector">
  <button id="btnBuy" class="main-btn">買入計算器</button>
  <button id="btnSell" class="main-btn">賣出計算器</button>
</div>

<section id="buySection">
  <label>實時黃金價格 (HKD / 台兩):</label>
  <input id="buyGoldPrice" type="number" readonly placeholder="載入中..." />
  <button id="refreshBuyPrice" style="margin:10px auto;display:block;">刷新金價</button>

  <label>景輝收金價 (HKD / 台兩):</label>
  <input id="chingfaiBuyPrice" type="number" min="0" step="0.01" placeholder="輸入本地收金價" />

  <label>重量 (1/1000 香港台兩):</label>
  <input id="buyWeight" type="number" min="0" step="any" placeholder="輸入重量" />

  <label>純度選擇:</label>
  <div class="inline-flex purity-options">
    <label><input type="radio" name="buyPurity" value="100" checked />100%</label>
    <label><input type="radio" name="buyPurity" value="75" />75%</label>
    <label><input type="radio" name="buyPurity" value="custom" />自訂</label>
  </div>
  <input id="buyPurityCustom" type="number" min="0" max="100" step="0.01" placeholder="自訂純度 (%)" style="display:none;" />

  <label>客戶要求收貨價 (HKD):</label>
  <input id="requestedBuyPrice" type="number" min="0" step="any" placeholder="可留空以使用計算結果" />

  <div class="result" id="buyResult"></div>
  <button id="resetBuy" type="button" class="main-btn">重置買入計算</button>
</section>

<section id="sellSection">
  <label>實時黃金價格 (HKD / 台兩):</label>
  <input id="sellGoldPrice" type="number" readonly placeholder="載入中..." />
  <button id="refreshSellPrice" style="margin:10px auto;display:block;">刷新金價</button>

  <label>景輝賣金價 (HKD / 台兩):</label>
  <input id="chingfaiSellPrice" type="number" min="0" step="0.01" placeholder="輸入本地賣金價" />

  <label>重量 (1/1000 香港台兩):</label>
  <input id="sellWeight" type="number" min="0" step="any" placeholder="輸入重量" />

  <label>純度選擇:</label>
  <div class="inline-flex purity-options">
    <label><input type="radio" name="sellPurity" value="100" checked />100%</label>
    <label><input type="radio" name="sellPurity" value="75" />75%</label>
    <label><input type="radio" name="sellPurity" value="custom" />自訂</label>
  </div>
  <input id="sellPurityCustom" type="number" min="0" max="100" step="0.01" placeholder="自訂純度 (%)" style="display:none;" />

  <label>人工費 (HKD):</label>
  <input id="labourCost" type="number" min="0" step="any" placeholder="輸入人工費用" />

  <label class="inline-flex"><input id="commissionSell" type="checkbox" checked /> 加入2%佣金</label>
  <label>售價 (HKD):</label>
  <input id="userSellingPrice" type="number" min="0" step="any" placeholder="可修改以模擬利潤" />

  <label>計算賣出價:</label>
  <div id="calculatedSellPrice" class="display-field">尚未計算</div>

  <label class="inline-flex"><input id="creditCardFee" type="checkbox" /> 承擔信用卡費用(3%) 
    <span id="creditCardFeeAmount" style="margin-left: 10px; font-weight: normal; font-size: 0.9em; color: #555;"></span>
  </label>

  <div class="result" id="sellResult"></div>
  <button id="resetSell" type="button" class="main-btn">重置賣出計算</button>
</section>

<script>
(() => {
  // UI Elements
  const buyBtn = document.getElementById('btnBuy');
  const sellBtn = document.getElementById('btnSell');
  const buySection = document.getElementById('buySection');
  const sellSection = document.getElementById('sellSection');

  const buyGoldPriceInput = document.getElementById('buyGoldPrice');
  const chingfaiBuyPriceInput = document.getElementById('chingfaiBuyPrice');
  const buyWeightInput = document.getElementById('buyWeight');
  const buyPurityRadios = document.getElementsByName('buyPurity');
  const buyPurityCustomInput = document.getElementById('buyPurityCustom');
  const requestedBuyPriceInput = document.getElementById('requestedBuyPrice');
  const buyResultDiv = document.getElementById('buyResult');
  const resetBuyBtn = document.getElementById('resetBuy');
  const refreshBuyPriceBtn = document.getElementById('refreshBuyPrice');

  const sellGoldPriceInput = document.getElementById('sellGoldPrice');
  const chingfaiSellPriceInput = document.getElementById('chingfaiSellPrice');
  const sellWeightInput = document.getElementById('sellWeight');
  const sellPurityRadios = document.getElementsByName('sellPurity');
  const sellPurityCustomInput = document.getElementById('sellPurityCustom');
  const labourCostInput = document.getElementById('labourCost');
  const commissionSellCheckbox = document.getElementById('commissionSell');
  const userSellingPriceInput = document.getElementById('userSellingPrice');
  const calculatedSellPriceDiv = document.getElementById('calculatedSellPrice');
  const creditCardFeeCheckbox = document.getElementById('creditCardFee');
  const creditCardFeeAmountSpan = document.getElementById('creditCardFeeAmount');
  const sellResultDiv = document.getElementById('sellResult');
  const resetSellBtn = document.getElementById('resetSell');
  const refreshSellPriceBtn = document.getElementById('refreshSellPrice');

  // Constants for conversion
  const gramsPerHongKongTael = 37.429;
  const gramsPerTroyOunce = 31.1035;

  // API key and endpoint
  const API_KEY = 'b59eca630c98a8dbc001ff5d576db229';
  const API_URL = `https://api.metalpriceapi.com/v1/latest?api_key=${API_KEY}&base=USD&currencies=XAU,HKD`;

  // Show only one section
  function showSection(section) {
    if (section === 'buy') {
      buySection.classList.add('active');
      sellSection.classList.remove('active');
    } else {
      sellSection.classList.add('active');
      buySection.classList.remove('active');
    }
  }

  // Get selected purity (including custom)
  function getSelectedPurity(radioNodeList, customInput) {
    for (const r of radioNodeList) {
      if (r.checked) {
        if (r.value === 'custom') {
          const val = parseFloat(customInput.value);
          return isNaN(val) ? 0 : val;
        }
        return parseFloat(r.value);
      }
    }
    return 0;
  }

  // Calculate pure gold weight from input weight and purity
  function calculatePureWeight(weightInput, purity) {
    const weightThousand = parseFloat(weightInput.value);
    if (isNaN(weightThousand) || purity <= 0) return 0;
    const weightTael = weightThousand / 1000;
    return weightTael * purity / 100;
  }

  // Calculate Buy In results
  function calculateBuy() {
    if (!buyGoldPriceInput.value || chingfaiBuyPriceInput.value === '') {
      buyResultDiv.textContent = '請輸入所有必要數據';
      return;
    }
    const purity = getSelectedPurity(buyPurityRadios, buyPurityCustomInput);
    const weightPure = calculatePureWeight(buyWeightInput, purity);
    const chingfaiPrice = parseFloat(chingfaiBuyPriceInput.value) || 0;
    const commissionMultiplier = 0.98; // Always apply 2% commission
    const estimatedBuyPrice = chingfaiPrice * weightPure * commissionMultiplier;
    let requestedPrice = parseFloat(requestedBuyPriceInput.value);
    if (isNaN(requestedPrice)) requestedPrice = estimatedBuyPrice;

    const profit = estimatedBuyPrice - requestedPrice;

    buyResultDiv.innerHTML = `
      純金重量: ${weightPure.toFixed(4)} 香港台兩<br/>
      實估買入價（扣佣後）: 港幣 ${estimatedBuyPrice.toFixed(2)}<br/>
      客戶要求收貨價: 港幣 ${requestedPrice.toFixed(2)}<br/>
      利潤: <span class="${profit >= 0 ? 'profit-positive' : 'profit-negative'}">港幣 ${profit.toFixed(2)} ${profit >= 0 ? '✅' : '❌'}</span>
    `;
  }

  // Calculate Sell Out results
  function calculateSell() {
    if (!sellGoldPriceInput.value || chingfaiSellPriceInput.value === '') {
      sellResultDiv.textContent = '請輸入所有必要數據';
      return;
    }
    const purity = getSelectedPurity(sellPurityRadios, sellPurityCustomInput);
    const weightPure = calculatePureWeight(sellWeightInput, purity);
    const chingfaiPrice = parseFloat(chingfaiSellPriceInput.value) || 0;
    let basePrice = chingfaiPrice * weightPure;
    if (commissionSellCheckbox.checked) basePrice *= 1.02;
    const userPrice = parseFloat(userSellingPriceInput.value);
    const sellPrice = !isNaN(userPrice) && userPrice > 0 ? userPrice : basePrice;
    const labourCost = parseFloat(labourCostInput.value) || 0;
    let profit = sellPrice - (weightPure * parseFloat(sellGoldPriceInput.value)) - labourCost;
    let creditCardCost = 0;
    if (creditCardFeeCheckbox.checked) {
      creditCardCost = sellPrice * 0.03;
      profit -= creditCardCost;
    }

    calculatedSellPriceDiv.textContent = basePrice > 0 ? `計算出的賣出價：HKD ${basePrice.toFixed(2)}` : '尚未計算';

    creditCardFeeAmountSpan.textContent = creditCardCost > 0 ? `(HKD ${creditCardCost.toFixed(2)})` : '';

    sellResultDiv.innerHTML = `
      純金重量: ${weightPure.toFixed(4)} 香港台兩<br/>
      理論黃金價值: 港幣 ${(weightPure * parseFloat(sellGoldPriceInput.value)).toFixed(2)}<br/>
      人工費用: 港幣 ${labourCost.toFixed(2)}<br/>
      ${creditCardFeeCheckbox.checked ? '承擔信用卡費用 (3%)<br/>' : ''}
      利潤: <span class="${profit >= 0 ? 'profit-positive' : 'profit-negative'}">港幣 ${profit.toFixed(2)} ${profit >= 0 ? '✅' : '❌'}</span>
    `;

    commissionDisplay.textContent = commissionSellCheckbox.checked && basePrice > 0
      ? `佣金2% 已包括，約為HKD ${(basePrice / 1.02 * 0.02).toFixed(2)}`
      : '佣金未計算';
  }

  // Reset Inputs
  function resetBuy() {
    chingfaiBuyPriceInput.value = '';
    buyWeightInput.value = '';
    buyPurityCustomInput.value = '';
    requestedBuyPriceInput.value = '';
    buyPurityRadios[0].checked = true;  // Default 100%
    calculateBuy();
  }

  function resetSell() {
    chingfaiSellPriceInput.value = '';
    sellWeightInput.value = '';
    labourCostInput.value = '';
    sellPurityCustomInput.value = '';
    userSellingPriceInput.value = '';
    commissionSellCheckbox.checked = true;
    creditCardFeeCheckbox.checked = false;
    sellPurityRadios[0].checked = true;  // Default 100%
    calculateSell();
  }

  // Event listeners binder helper
  function addInputListeners() {
    // Buy inputs
    [chingfaiBuyPriceInput, buyWeightInput, requestedBuyPriceInput].forEach(ip => ip.addEventListener('input', calculateBuy));
    buyPurityRadios.forEach(r => r.addEventListener('change', () => {
      if (r.value === 'custom') {
        buyPurityCustomInput.style.display = 'block';      
      } else {
        buyPurityCustomInput.style.display = 'none';
      }
      calculateBuy();
    }));
    buyPurityCustomInput.addEventListener('input', calculateBuy);

    // Sell inputs
    [chingfaiSellPriceInput, sellWeightInput, labourCostInput, userSellingPriceInput].forEach(ip => ip.addEventListener('input', calculateSell));
    commissionSellCheckbox.addEventListener('change', calculateSell);
    creditCardFeeCheckbox.addEventListener('change', calculateSell);
    sellPurityRadios.forEach(r => r.addEventListener('change', () => {
      if (r.value === 'custom') {
        sellPurityCustomInput.style.display = 'block';
      } else {
        sellPurityCustomInput.style.display = 'none';
      }
      calculateSell();
    }));
    sellPurityCustomInput.addEventListener('input', calculateSell);
  }

  // Show and hide purity custom inputs initially
  buyPurityCustomInput.style.display = 'none';
  sellPurityCustomInput.style.display = 'none';

  // Toggle sections buttons
  buyBtn.addEventListener('click', () => showSection('buy'));
  sellBtn.addEventListener('click', () => showSection('sell'));

  // Reset buttons
  resetBuyBtn.addEventListener('click', resetBuy);
  resetSellBtn.addEventListener('click', resetSell);

  // Refresh price buttons
  refreshBuyPriceBtn.addEventListener('click', fetchGoldPrice);
  refreshSellPriceBtn.addEventListener('click', fetchGoldPrice);

  // Show Buy calculator on load
  showSection('buy');

  addInputListeners();

  // Fetch gold price from API using metalpriceapi.com
  function fetchGoldPrice() {
    fetch(API_URL)
      .then(res => res.json())
      .then(data => {
        if (data.success && data.rates && data.rates.XAU && data.rates.HKD) {
          const goldPriceUSD = data.rates.XAU;
          const usdToHkd = data.rates.HKD;
          const goldPriceHKD = goldPriceUSD * usdToHkd;
          const pricePerHKTael = goldPriceHKD * (gramsPerHongKongTael / gramsPerTroyOunce);
          baseBuyGoldPrice = pricePerHKTael;

          buyGoldPriceInput.value = pricePerHKTael.toFixed(2);
          sellGoldPriceInput.value = pricePerHKTael.toFixed(2);
          calculateBuy();
          calculateSell();
        } else {
          alert('無法取得黃金價格');
        }
      })
      .catch(err => alert('獲取黃金價格時出錯: ' + err));
  }

  // Initial fetch on page load
  fetchGoldPrice();

})();
</script>

</body>
</html>

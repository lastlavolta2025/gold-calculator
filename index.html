<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>黃金買賣計算器</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 470px; margin: auto; padding: 20px; }
  h1 { text-align: center; margin-bottom: 20px; }
  h2 { text-align: center; margin-bottom: 20px; }
  .result { margin-top: 12px; font-weight: bold; font-size: 1.1em; }
  .profit-positive { color: green; }
  .profit-negative { color: red; }
  .checkbox-label { font-size: 1.05em; display: flex; align-items: center; margin-bottom: 15px; }
  input[type=number], input[type=text] { padding: 8px; box-sizing: border-box; font-size: 1.1em; }
  input[type=checkbox] { width: auto; margin-right: 6px; }
  button.main-btn {
    display: block;
    width: 80%;
    margin: 10px auto 20px auto;
    padding: 15px;
    font-size: 1.2em;
    cursor: pointer;
    border-radius: 8px;
    border: 1px solid #007bff;
    background-color: #007bff;
    color: white;
    transition: background-color 0.3s ease;
  }
  button.main-btn:hover { background-color: #0056b3; }
  button.small-btn {
    padding: 6px 12px;
    font-size: 0.9em;
    cursor: pointer;
    border-radius: 6px;
    border: 1px solid #6c757d;
    background-color: #6c757d;
    color: white;
    transition: background-color 0.3s ease;
    margin-left: 10px;
  }
  button.small-btn:hover { background-color: #5a6268; }
  section { border: 1px solid #ccc; padding: 15px; margin-bottom: 30px; border-radius: 8px; }
  label, input, span { display: block; margin-bottom: 8px; width: 100%; }
  #adjustedBuyPriceDisplay, #chingfaiPriceDisplay, #commissionAmountDisplay, #totalSellingPriceDisplay {
    font-size: 1em; color: #007bff; margin: 0 0 10px 0;
  }
  #backBtnBuy, #backBtnSell {
    margin-top: 10px;
    background-color: #6c757d;
    border-color: #6c757d;
  }
  #backBtnBuy:hover, #backBtnSell:hover {
    background-color: #5a6268;
  }
  .inline-flex {
    display: flex;
    align-items: center;
  }
  .inline-flex > label {
    margin-right: 10px;
    margin-bottom: 0;
    white-space: nowrap;
  }
  .display-field {
    border: 1px solid #ddd;
    padding: 8px;
    border-radius: 6px;
    background-color: #f9f9f9;
    font-size: 1.1em;
    color: #333;
    margin-top: 4px;
    user-select: none;
  }
  .purity-options {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
  }
  .purity-options label {
    font-size: 1.1em;
    cursor: pointer;
    user-select: none;
  }
</style>
</head>
<body>

<h1 id="pageHeader">黃金買賣計算器</h1>

<div id="homeScreen">
  <button id="btnBuyIn" class="main-btn">買入計算器</button>
  <button id="btnSellOut" class="main-btn">賣出計算器</button>
</div>

<!-- Buy In -->
<section id="buySection" style="display:none;">
  <h2>買入計算器</h2>
  <div class="inline-flex">
    <label for="buyGoldPrice">黃金價格 (港幣 / 香港台兩):</label>
    <button type="button" id="refreshGoldPriceBuy" class="small-btn" title="刷新黃金價格">刷新</button>
    <button type="button" id="resetBuy" class="small-btn" title="重置所有輸入欄位">重置</button>
  </div>
  <input type="number" id="buyGoldPrice" value="" readonly inputmode="decimal" pattern="[0-9]*" />
  <label for="chingfaiBuyPrice" style="margin-top: 12px;">景輝收金價 (港幣 / 香港台兩):</label>
  <input type="number" id="chingfaiBuyPrice" value="" min="0" step="any" inputmode="decimal" pattern="[0-9]*" />

  <span id="adjustedBuyPriceDisplay"></span>
  <div class="purity-options">
    <label><input type="radio" name="buyPurityPreset" value="100" id="buyPurity100" checked /> 100%</label>
    <label><input type="radio" name="buyPurityPreset" value="75" id="buyPurity75" /> 75%</label>
    <label><input type="radio" name="buyPurityPreset" value="custom" id="buyPurityCustom" /> 自訂</label>
  </div>
  <label>純度 (%): <input type="number" id="buyPurity" value="100" min="0" max="100" step="0.01" inputmode="decimal" pattern="[0-9]*" /></label>
  <label>重量 (千分之一香港台兩): <input type="number" id="buyWeight" value="" min="0" step="any" inputmode="decimal" pattern="[0-9]*" /></label>
  <label>客戶要求收貨價 (港幣): <input type="number" id="requestedBuyPrice" value="" min="0" step="any" inputmode="decimal" pattern="[0-9]*" /></label>

  <div class="result" id="buyResult">尚未更新黃金價格</div>
  <button id="backBtnBuy" class="main-btn">返回主頁</button>
</section>

<!-- Sell Out -->
<section id="sellSection" style="display:none;">
  <h2>賣出計算器</h2>
  <div class="inline-flex">
    <label for="sellGoldPrice">黃金價格 (港幣 / 香港台兩):</label>
    <button type="button" id="refreshGoldPriceSell" class="small-btn" title="刷新黃金價格">刷新</button>
    <button type="button" id="resetSell" class="small-btn" title="重置所有輸入欄位">重置</button>
  </div>
  <input type="number" id="sellGoldPrice" value="" readonly inputmode="decimal" pattern="[0-9]*" />

  <label for="chingfaiPrice" style="margin-top: 12px;">景輝金價 (港幣 / 香港台兩):</label>
  <input type="number" id="chingfaiPrice" value="" min="0" step="any" inputmode="decimal" pattern="[0-9]*" />
  <span id="chingfaiPriceDisplay"></span>

  <label>重量 (千分之一香港台兩):
    <input type="number" id="sellWeight" value="" min="0" step="any" inputmode="decimal" pattern="[0-9]*" />
  </label>

  <div class="purity-options">
    <label><input type="radio" name="purityPreset" value="100" id="purity100" checked /> 100%</label>
    <label><input type="radio" name="purityPreset" value="75" id="purity75" /> 75%</label>
    <label><input type="radio" name="purityPreset" value="custom" id="purityCustom" /> 自訂</label>
  </div>
  <label>純度 (%): 
    <input type="number" id="sellPurity" value="100" min="0" max="100" step="0.01" inputmode="decimal" pattern="[0-9]*" />
  </label>
  <label>人工費 (港幣): <input type="number" id="labourCost" value="" min="0" step="any" inputmode="decimal" pattern="[0-9]*" /></label>
  <label><input type="checkbox" id="commissionCheck" checked /> 佣金2%</label>
  <label>售價 (港幣): <input type="number" id="userSellingPrice" value="" min="0" step="any" inputmode="decimal" pattern="[0-9]*" /></label>
  <label>賣出價 (港幣): <div id="calculatedSellingPrice" class="display-field">尚未計算</div></label>
  <div id="commissionDisplay"></div>
  <span id="totalSellingPriceDisplay" style="color:#007bff; margin-top: -10px; margin-bottom: 15px;"></span>
  <label><input type="checkbox" id="creditCardCharge" /> 承擔信用卡費用 (3%)
    <span id="creditCardChargeAmount" style="margin-left: 10px; font-weight: normal; font-size: 0.95em; color: #555;"></span></label>
  <div class="result" id="sellResult">尚未更新黃金價格</div>
  <button id="backBtnSell" class="main-btn">返回主頁</button>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    let baseBuyGoldPrice = 0;

    // DOM variables
    const homeScreen = document.getElementById('homeScreen');
    const buySection = document.getElementById('buySection');
    const sellSection = document.getElementById('sellSection');
    const pageHeader = document.getElementById('pageHeader');

    const premiumCheck = document.getElementById('buyCommissionCheck');
    const sellCommissionCheck = document.getElementById('commissionCheck');
    const creditCardCharge = document.getElementById('creditCardCharge');
    const creditCardAmountSpan = document.getElementById('creditCardChargeAmount');
    const commissionDisplay = document.getElementById('commissionDisplay');
    const adjustedBuyPriceDisplay = document.getElementById('adjustedBuyPriceDisplay');
    const chingfaiBuyPriceInput = document.getElementById('chingfaiBuyPrice');
    const requestedBuyPriceInput = document.getElementById('requestedBuyPrice');
    const userSellingPriceInput = document.getElementById('userSellingPrice');
    const calculatedSellPriceDiv = document.getElementById('calculatedSellingPrice');
    const chingfaiPriceInput = document.getElementById('chingfaiPrice');
    const chingfaiPriceDisplay = document.getElementById('chingfaiPriceDisplay');
    const totalSellPriceDisplay = document.getElementById('totalSellingPriceDisplay');

    const purityRadiosBuy = document.getElementsByName('buyPurityPreset');
    const buyPurityInput = document.getElementById('buyPurity');
    const purityRadiosSell = document.getElementsByName('purityPreset');
    const sellPurityInput = document.getElementById('sellPurity');

    // Show/hide functions
    function showBuy() { homeScreen.style.display = 'none'; buySection.style.display = 'block'; sellSection.style.display = 'none'; pageHeader.textContent='買入計算器'; }
    function showSell() { homeScreen.style.display = 'none'; sellSection.style.display = 'block'; buySection.style.display='none'; pageHeader.textContent='賣出計算器'; }
    function showHome() { homeScreen.style.display='block'; buySection.style.display='none'; sellSection.style.display='none'; pageHeader.textContent=''; }

    document.getElementById('btnBuyIn').addEventListener('click', showBuy);
    document.getElementById('btnSellOut').addEventListener('click', showSell);
    document.getElementById('backBtnBuy').addEventListener('click', showHome);
    document.getElementById('backBtnSell').addEventListener('click', showHome);

    function formatProfit(p) { return p>=0 ? '<span class="profit-positive">港幣 '+p.toFixed(2)+' ✅</span>' : '<span class="profit-negative">港幣 '+p.toFixed(2)+' ❌</span>'; }

    function getPureWeight(id, purityPercent) {
      const w = parseFloat(document.getElementById(id).value) || 0;
      return (w/1000) * (purityPercent/100);
    }

    // Calculate buy
    function calcBuy() {
      const includeCommission = premiumCheck.checked;
      let buyPrice = parseFloat(document.getElementById('buyGoldPrice').value) || 0;
      let chingfaiPrice = parseFloat(chingfaiBuyPriceInput.value) || 0;
      let commissionMultiplier = includeCommission ? 0.98 : 1.0;

      adjustedBuyPriceDisplay.textContent = includeCommission
        ? `計算假設扣除2%佣金，實際買入價格將乘以0.98`
        : '';

      const purity = parseFloat(buyPurityInput.value) || 0;
      const weight = getPureWeight('buyWeight', purity);
      const effectiveBuyValue = chingfaiPrice * weight * commissionMultiplier;

      const requestedPrice = parseFloat(requestedBuyPriceInput.value) || 0;
      const buyCost = requestedPrice > 0 ? requestedPrice : effectiveBuyValue;
      const profit = effectiveBuyValue - buyCost;

      document.getElementById('buyResult').innerHTML = `
        純金重量: ${weight.toFixed(4)} 香港台兩<br/>
        實估買入價（扣佣後）: 港幣 ${effectiveBuyValue.toFixed(2)}<br/>
        客戶要求收貨價: 港幣 ${buyCost.toFixed(2)}<br/>
        利潤: ${formatProfit(profit)}
      `;
    }

    // Calculate sell
    function calcSell() {
      const goldPrice = parseFloat(document.getElementById('sellGoldPrice').value) || 0;
      const labourCost = parseFloat(document.getElementById('labourCost').value) || 0;
      const creditCheck = document.getElementById('creditCardCharge').checked;
      const includeCommission = sellCommissionCheck.checked;

      // Purity calculation
      let purityPercent = 0;
      for (const r of purityRadiosSell) {
        if (r.checked) {
          if (r.value==='custom') {
            purityPercent = parseFloat(sellPurityInput.value) || 0;
          } else {
            purityPercent = parseFloat(r.value);
          }
          break;
        }
      }

      const weight = getPureWeight('sellWeight', purityPercent);
      let chingfaiPrice = parseFloat(chingfaiPriceInput.value) || 0;

      let basePrice = 0;
      if (chingfaiPrice > 0) {
        basePrice = chingfaiPrice * weight;
        if (includeCommission) basePrice *= 1.02;
      }

      // Calculate and show the reference sell price
      calculatedSellPriceDiv = document.getElementById('calculatedSellingPrice');
      if (basePrice>0) {
        calculatedSellPriceDiv.textContent='計算出的賣出價：HKD '+basePrice.toFixed(2);
      } else {
        calculatedSellPriceDiv.textContent='尚未計算';
      }

      // 利用用戶自己輸入的售價來計算利潤，若沒有則用計算出來的
      let userPrice = parseFloat(userSellingPriceInput.value) || 0;
      let actualSellPrice = userPrice > 0 ? userPrice : basePrice;

      let profit = actualSellPrice - (weight * goldPrice) - labourCost;
      let cChargeAmount = 0;
      if (creditCheck) {
        cChargeAmount = actualSellPrice * 0.03;
        profit -= cChargeAmount;
      }

      document.getElementById('sellResult').innerHTML = `
        純金重量: ${weight.toFixed(4)} 香港台兩<br/>
        理論黃金價值: 港幣 ${(weight*goldPrice).toFixed(2)}<br/>
        人工費: 港幣 ${labourCost}
        ${creditCheck ? '<br/>承擔信用卡費用 (3%)' : ''}
        <br/>利潤: ${formatProfit(profit)}
      `;

      // 統一在這裡顯示 2% 佣金的金額
      document.getElementById('commissionDisplay').textContent = 
        (sellCommissionCheck.checked) ? `已計算2%佣金，約港幣 ${(actualSellPrice*0.02).toFixed(2)}` : '';
    }

    // 事件設置
    document.querySelectorAll('#buySection input:not(#buyGoldPrice,#premiumCheck)').forEach(el => el.addEventListener('input', calcBuy));
    document.querySelectorAll('#sellSection input:not(#sellGoldPrice)').forEach(el => el.addEventListener('input', calcSell));
    document.getElementById('requestedBuyPrice').addEventListener('input', calcBuy);
    document.getElementById('userSellingPrice').addEventListener('input', calcSell);
    premiumCheck.addEventListener('change', calcBuy);
    sellCommissionCheck.addEventListener('change', calcSell);
    document.getElementById('creditCardCharge').addEventListener('change', calcSell);
    document.getElementById('creditCardCharge').addEventListener('change', calcSell);
    document.getElementById('resetBuy').addEventListener('click', () => {
      document.getElementById('chingfaiBuyPrice').value='';
      document.getElementById('buyWeight').value='';
      document.getElementById('buyPurity').value='100';
      document.getElementById('requestedBuyPrice').value='';
      calcBuy();
    });
    document.getElementById('resetSell').addEventListener('click', () => {
      document.getElementById('sellWeight').value='';
      document.getElementById('sellPurity').value='100';
      document.getElementById('labourCost').value='';
      document.getElementById('chingfaiPrice').value='';
      document.getElementById('userSellingPrice').value='';
      for (const r of purityRadiosSell) { if (r.value==='100') r.checked=true; }
      calcSell();
    });
    document.getElementById('refreshGoldPriceBuy').addEventListener('click', fetchGoldPrice);
    document.getElementById('refreshGoldPriceSell').addEventListener('click', fetchGoldPrice);

    // 初始化
    fetchGoldPrice();

    function fetchGoldPrice() {
      const apiKey='goldapi-h9jxismg9jskvl-io';
      fetch('https://www.goldapi.io/api/XAU/HKD', {
        method: 'GET', headers: { 'x-access-token': apiKey }
      }).then(res => res.json())
        .then(data => {
          if(data.price) {
            const p = data.price;
            const p2 = p * (37.429/31.1035);
            baseBuyGoldPrice=p2;
            document.getElementById('buyGoldPrice').value=p2.toFixed(2);
            document.getElementById('sellGoldPrice').value=p2.toFixed(2);
            calcBuy(); calcSell();
          } else alert('無法取得金價');
        }).catch(e => alert('API錯誤：'+e));
    }

  });
</script>

</body>
</html>
